<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

    <title>Trainingstagebuch</title>
</head>

<body>
    <div class="container-fluid">
        <div id='input-block'>
            <div class="row justify-content-center">
                <h1 class="display-5">Training</h1>
            </div>
            <div class="row justify-content-center">
                <div class="btn-group btn-block btn-group-toggle btn-group-vertical">
                    <label class="btn btn-secondary active">
                        <input type="radio" name="options">Liegestützen
                    </label>
                    <label class="btn btn-block btn-secondary">
                        <input type="radio" name="options">Skip Rope
                    </label>
                    <label class="btn btn-block btn-secondary">
                        <input type="radio" name="options">Rumpfbeugen
                    </label>
                    <label class="btn btn-block btn-secondary">
                        <input type="radio" name="options">Biceps Curl
                    </label>
                </div>
            </div>
            <div class="row justify-content-center p-4">
                <input id="amount" inputmode="numeric" pattern="[0-9]*" type="text" name="amount" class="form-control"
                    placeholder="Amount" aria-label="Amount" aria-describedby="basic-addon2">
            </div>
            <div class="row justify-content-center">
                <button type="button" id="save" class="btn btn-block btn-primary" data-toggle="button"
                    aria-pressed="false">
                    Speichern
                </button>
            </div>

            <div class="row justify-content-center p-4">
                <div class="alert alert-primary" role="alert" style="display: none;">

                </div>
            </div>

            <div class="row justify-content-center p-4">
                <h1 class="display-5">Übersicht</h1>
            </div>

            <div class="row justify-content-center">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Liegestützen</th>
                            <th>Skip Rope</th>
                            <th>Rumpfbeugen</th>
                            <th>Biceps Curl</th>
                        </tr>
                    </thead>
                    <tbody id="data"></tbody>
                </table>
            </div>
        </div>

        <div class="row justify-content-center p-5">
            <!--Add buttons to initiate auth sequence and sign out-->
            <button id="authorize_button" class="btn btn-secondary" style="display: none;">Authorize</button>
            <button id="signout_button" class="btn btn-secondary" style="display: none;">Sign Out</button>
        </div>
    </div>

    <script type="text/javascript">
        // Client ID and API key from the Developer Console
        var CLIENT_ID = '1074737167196-vkgmi20tjd0a4ivuq83v6739bch3781c.apps.googleusercontent.com';
        var API_KEY = '';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "profile https://www.googleapis.com/auth/spreadsheets";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');

        var activity = 'Liegestützen';
        var amount;
        var inputSheetName;
        var overviewSheetName;

        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
            auth2 = gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            }, function (error) {
                showMessage(JSON.stringify(error, null, 2));
            });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                $('#input-block').show();

                var profile = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile();
                console.log('ID: ' + profile.getId());
                console.log('Full Name: ' + profile.getName());
                console.log('Given Name: ' + profile.getGivenName());
                console.log('Family Name: ' + profile.getFamilyName());
                console.log('Image URL: ' + profile.getImageUrl());
                console.log('Email: ' + profile.getEmail());
                showMessage('Hoi, ' + profile.getGivenName());
                inputSheetName = 'Daten ' + profile.getGivenName();
                overviewSheetName = 'Training ' + profile.getGivenName();
                getTrainingData();
            } else {
                $('#input-block').hide();
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
            }
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        function showMessage(message) {
            $('.alert-primary').empty();
            $('.alert-primary').show().append(message);
        }

        function getTrainingData() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1y6uvVwnEo3u7gqCv9tFVSMZPG0oCm95DomD8w72hhEA',
                range: overviewSheetName + '!A2:E',
            }).then(function (response) {
                var range = response.result;
                var elem = $('#data');
                $('#data').empty();
                if (range.values.length > 0) {
                    for (i = 0; i < range.values.length; i++) {
                        var row = range.values[i];
                        elem.append("<tr><td>" + row[0] + "</td><td>"
                            + row[1] + "</td><td>"
                            + row[2] + "</td><td>"
                            + row[3] + "</td><td>"
                            + row[4] + "</td></tr>");
                    }
                } else {
                    elem.append('No data found.');
                }
            }, function (response) {
                console.log(response.result.error);
                showMessage('Error: ' + response.result.error.message);
            });
        }

        $('.btn-group-toggle .btn').on('click', function (event) {
            $(".btn-group > .btn").removeClass("active");
            $(this).addClass("active");
            activity = $(this).text().trim();
        });

        $('#save').on('click', function (event) {
            amount = $('#amount').val().trim();
            var body = {
                values: [
                    [
                        moment().format('DD.MM.YYYY'),
                        moment().format('HH:mm:ss'),
                        activity === 'Liegestützen' ? amount : null,
                        activity === 'Skip Rope' ? amount : null,
                        activity === 'Rumpfbeugen' ? amount : null,
                        activity === 'Biceps Curl' ? amount : null
                    ]
                ],
            }
            gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: '1y6uvVwnEo3u7gqCv9tFVSMZPG0oCm95DomD8w72hhEA',
                range: inputSheetName,
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS'
            }, body).then(function (response) {
                if (response.status === 200) {
                    showMessage('Daten gespeichert');
                    getTrainingData();
                } else {
                    console.log(response.result.error);
                    showMessage('Error: ' + response.result.error.message);
                }

            });
        });

    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
        </script>
</body>

</html>